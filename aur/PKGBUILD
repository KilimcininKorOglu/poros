# Maintainer: Your Name <your.email@example.com>
# AUR Package for Poros - Modern Network Path Tracer

pkgname=poros
pkgver=1.0.0
pkgrel=1
pkgdesc="Modern, cross-platform network path tracer with TUI support"
arch=('x86_64' 'aarch64')
url="https://github.com/KilimcininKorOglu/poros"
license=('MIT')
depends=('glibc')
makedepends=('go>=1.21')
optdepends=('libcap: for running without root via capabilities')
provides=('poros')
conflicts=('poros-bin' 'poros-git')
source=("${pkgname}-${pkgver}.tar.gz::https://github.com/KilimcininKorOglu/poros/archive/v${pkgver}.tar.gz")
sha256sums=('SKIP')  # Update with actual checksum on release

build() {
    cd "${pkgname}-${pkgver}"
    
    export CGO_CPPFLAGS="${CPPFLAGS}"
    export CGO_CFLAGS="${CFLAGS}"
    export CGO_CXXFLAGS="${CXXFLAGS}"
    export CGO_LDFLAGS="${LDFLAGS}"
    export GOFLAGS="-buildmode=pie -trimpath -ldflags=-linkmode=external -mod=readonly -modcacherw"
    
    go build -ldflags "-s -w -X main.version=${pkgver}" -o poros ./cmd/poros
}

package() {
    cd "${pkgname}-${pkgver}"
    
    # Install binary
    install -Dm755 poros "${pkgdir}/usr/bin/poros"
    
    # Install man page
    install -Dm644 man/poros.1 "${pkgdir}/usr/share/man/man1/poros.1"
    
    # Install documentation
    install -Dm644 README.md "${pkgdir}/usr/share/doc/${pkgname}/README.md"
    install -Dm644 docs/PLATFORMS.md "${pkgdir}/usr/share/doc/${pkgname}/PLATFORMS.md"
    
    # Install license
    install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}

post_install() {
    echo "To use poros without root, set capabilities:"
    echo "  sudo setcap cap_net_raw+ep /usr/bin/poros"
}
