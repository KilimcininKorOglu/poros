# Feature 013: HTML Report Export

**Feature ID:** F013
**Feature Name:** HTML Report Export
**Priority:** P3 - MEDIUM
**Target Version:** v0.5.0
**Estimated Duration:** 1 week
**Status:** NOT_STARTED

## Overview

Implement HTML report generation that creates a standalone, shareable HTML file with visual path representation, latency graphs, and all trace data. The report should be self-contained with embedded CSS/JS and viewable in any browser.

## Goals
- Generate standalone HTML report
- Include visual path diagram
- Show latency charts
- Display all enrichment data
- Make reports shareable (no external dependencies)

## Success Criteria
- [ ] All tasks completed (T085-T089)
- [ ] HTML opens in any modern browser
- [ ] No external resources required
- [ ] Charts render correctly
- [ ] Mobile-responsive design

## Tasks

### T085: Design HTML Report Template

**Status:** NOT_STARTED
**Priority:** P1
**Estimated Effort:** 1 day

#### Description
Create the HTML template structure with embedded CSS for styling and layout.

#### Technical Details
```go
// internal/output/html.go
const htmlTemplate = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Poros Trace Report - {{.Target}}</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --text-primary: #eef;
            --text-secondary: #aab;
            --accent: #0f3460;
            --highlight: #e94560;
            --success: #00d9a5;
            --warning: #ffc107;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 2rem;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        header {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        h1 { color: var(--highlight); margin-bottom: 0.5rem; }
        
        .meta { color: var(--text-secondary); font-size: 0.9rem; }
        
        .hop-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--bg-secondary);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .hop-table th {
            background: var(--accent);
            padding: 1rem;
            text-align: left;
        }
        
        .hop-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--accent);
        }
        
        .hop-table tr:hover { background: rgba(255,255,255,0.05); }
        
        .rtt-bar {
            display: inline-block;
            height: 8px;
            background: var(--success);
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .rtt-bar.medium { background: var(--warning); }
        .rtt-bar.high { background: var(--highlight); }
        
        .timeout { color: var(--highlight); }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .summary-card {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--success);
        }
        
        @media (max-width: 768px) {
            body { padding: 1rem; }
            .hop-table { font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ”± Poros Trace Report</h1>
            <div class="meta">
                <p>Target: <strong>{{.Target}}</strong> ({{.ResolvedIP}})</p>
                <p>Method: {{.ProbeMethod}} | Time: {{.Timestamp}}</p>
            </div>
        </header>
        
        <main>
            {{template "hopTable" .Hops}}
            {{template "summary" .Summary}}
            {{template "chart" .Hops}}
        </main>
        
        <footer>
            <p>Generated by <a href="https://github.com/user/poros">Poros</a></p>
        </footer>
    </div>
    
    {{template "scripts" .}}
</body>
</html>`
```

#### Files to Touch
- `internal/output/html.go` (new)
- `internal/output/html_templates.go` (new)

#### Dependencies
- T020: Formatter interface

#### Success Criteria
- [ ] Template compiles
- [ ] CSS is embedded
- [ ] Responsive design works

---

### T086: Implement Hop Table Generation

**Status:** NOT_STARTED
**Priority:** P1
**Estimated Effort:** 1 day

#### Description
Generate the hop table HTML with all trace data and RTT visualization.

#### Technical Details
```go
// internal/output/html_templates.go
const hopTableTemplate = `
{{define "hopTable"}}
<table class="hop-table">
    <thead>
        <tr>
            <th>#</th>
            <th>IP Address</th>
            <th>Hostname</th>
            <th>ASN</th>
            <th>Location</th>
            <th>RTT</th>
            <th>Latency</th>
        </tr>
    </thead>
    <tbody>
        {{range .}}
        <tr>
            <td>{{.Number}}</td>
            <td>{{if .IP}}{{.IP}}{{else}}<span class="timeout">*</span>{{end}}</td>
            <td>{{.Hostname}}</td>
            <td>{{if .ASN}}AS{{.ASN.Number}} - {{.ASN.Org}}{{end}}</td>
            <td>{{if .Geo}}{{.Geo.City}}, {{.Geo.CountryCode}}{{end}}</td>
            <td>{{formatRTT .AvgRTT}}</td>
            <td>
                {{if gt .AvgRTT 0}}
                <div class="rtt-bar {{rttClass .AvgRTT}}" style="width: {{rttWidth .AvgRTT}}px"></div>
                {{end}}
            </td>
        </tr>
        {{end}}
    </tbody>
</table>
{{end}}`

func rttClass(rtt float64) string {
    switch {
    case rtt < 50:
        return ""
    case rtt < 150:
        return "medium"
    default:
        return "high"
    }
}

func rttWidth(rtt float64) int {
    // Scale to max 200px
    width := int(rtt / 2)
    if width > 200 {
        width = 200
    }
    return width
}
```

#### Files to Touch
- `internal/output/html_templates.go` (update)
- `internal/output/html_funcs.go` (new)

#### Dependencies
- T085: HTML template structure

#### Success Criteria
- [ ] All columns populated
- [ ] RTT bars render
- [ ] Timeout hops shown
- [ ] ASN/Geo display

---

### T087: Implement Latency Chart

**Status:** NOT_STARTED
**Priority:** P2
**Estimated Effort:** 1 day

#### Description
Add an interactive latency chart using embedded JavaScript (no external libraries).

#### Technical Details
```go
// internal/output/html_templates.go
const chartTemplate = `
{{define "chart"}}
<section class="chart-section">
    <h2>Latency Chart</h2>
    <canvas id="latencyChart" width="800" height="300"></canvas>
</section>
{{end}}

{{define "scripts"}}
<script>
(function() {
    const hops = {{.HopsJSON}};
    const canvas = document.getElementById('latencyChart');
    const ctx = canvas.getContext('2d');
    
    // Chart dimensions
    const padding = 40;
    const width = canvas.width - padding * 2;
    const height = canvas.height - padding * 2;
    
    // Find max RTT for scaling
    const maxRTT = Math.max(...hops.map(h => h.avg_rtt || 0), 100);
    
    // Draw axes
    ctx.strokeStyle = '#aab';
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, height + padding);
    ctx.lineTo(width + padding, height + padding);
    ctx.stroke();
    
    // Draw bars
    const barWidth = width / hops.length - 4;
    
    hops.forEach((hop, i) => {
        if (hop.avg_rtt <= 0) return;
        
        const barHeight = (hop.avg_rtt / maxRTT) * height;
        const x = padding + i * (barWidth + 4);
        const y = height + padding - barHeight;
        
        // Color based on RTT
        let color = '#00d9a5';
        if (hop.avg_rtt > 150) color = '#e94560';
        else if (hop.avg_rtt > 50) color = '#ffc107';
        
        ctx.fillStyle = color;
        ctx.fillRect(x, y, barWidth, barHeight);
        
        // Hop number label
        ctx.fillStyle = '#aab';
        ctx.font = '10px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(hop.hop, x + barWidth/2, height + padding + 15);
    });
    
    // Y-axis labels
    ctx.fillStyle = '#aab';
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'right';
    for (let i = 0; i <= 5; i++) {
        const value = Math.round(maxRTT * i / 5);
        const y = height + padding - (height * i / 5);
        ctx.fillText(value + 'ms', padding - 5, y + 3);
    }
})();
</script>
{{end}}`

type HTMLFormatter struct {
    config FormatterConfig
}

func (f *HTMLFormatter) Format(result *trace.TraceResult) ([]byte, error) {
    // Prepare template data
    data := HTMLData{
        Target:      result.Target,
        ResolvedIP:  result.ResolvedIP.String(),
        ProbeMethod: result.ProbeMethod,
        Timestamp:   result.Timestamp.Format("2006-01-02 15:04:05"),
        Hops:        result.Hops,
        Summary:     result.Summary,
    }
    
    // JSON for chart
    hopsJSON, _ := json.Marshal(f.hopsToChartData(result.Hops))
    data.HopsJSON = template.JS(hopsJSON)
    
    // Execute template
    tmpl := template.Must(template.New("report").
        Funcs(template.FuncMap{
            "formatRTT": formatRTT,
            "rttClass":  rttClass,
            "rttWidth":  rttWidth,
        }).
        Parse(htmlTemplate + hopTableTemplate + chartTemplate))
    
    var buf bytes.Buffer
    if err := tmpl.Execute(&buf, data); err != nil {
        return nil, err
    }
    
    return buf.Bytes(), nil
}
```

#### Files to Touch
- `internal/output/html_templates.go` (update)
- `internal/output/html.go` (update)

#### Dependencies
- T086: Hop table

#### Success Criteria
- [ ] Chart renders correctly
- [ ] No external JS needed
- [ ] Scales appropriately
- [ ] Shows all hops

---

### T088: Add HTML CLI Flag

**Status:** NOT_STARTED
**Priority:** P1
**Estimated Effort:** 0.5 days

#### Description
Add `--html` flag to generate HTML report.

#### Technical Details
```go
// cmd/poros/root.go (update)
func init() {
    rootCmd.Flags().String("html", "", 
        "Generate HTML report to specified file")
}

func runTrace(cmd *cobra.Command, args []string) error {
    // ... trace execution ...
    
    // Handle HTML output
    htmlFile := getString(cmd, "html")
    if htmlFile != "" {
        formatter := output.NewHTMLFormatter(output.FormatterConfig{})
        data, err := formatter.Format(result)
        if err != nil {
            return err
        }
        
        if err := os.WriteFile(htmlFile, data, 0644); err != nil {
            return err
        }
        
        fmt.Printf("HTML report saved to: %s\n", htmlFile)
    }
    
    // ... regular output
}
```

#### Files to Touch
- `cmd/poros/root.go` (update)

#### Dependencies
- T087: Latency chart

#### Success Criteria
- [ ] `--html report.html` creates file
- [ ] Report opens in browser
- [ ] Success message shown

---

### T089: Add HTML Report Tests

**Status:** NOT_STARTED
**Priority:** P2
**Estimated Effort:** 0.5 days

#### Description
Create tests for HTML report generation.

#### Technical Details
```go
// internal/output/html_test.go
func TestHTMLFormatter(t *testing.T) {
    result := &trace.TraceResult{
        Target:     "google.com",
        ResolvedIP: net.ParseIP("142.250.185.238"),
        Hops: []trace.Hop{
            {Number: 1, IP: net.ParseIP("192.168.1.1"), AvgRTT: 1.5},
            {Number: 2, IP: net.ParseIP("10.0.0.1"), AvgRTT: 5.2},
        },
    }
    
    formatter := NewHTMLFormatter(FormatterConfig{})
    data, err := formatter.Format(result)
    require.NoError(t, err)
    
    html := string(data)
    
    // Verify structure
    assert.Contains(t, html, "<!DOCTYPE html>")
    assert.Contains(t, html, "google.com")
    assert.Contains(t, html, "192.168.1.1")
    assert.Contains(t, html, "latencyChart")
    
    // Verify no external resources
    assert.NotContains(t, html, "http://")
    assert.NotContains(t, html, "https://")
}

func TestHTMLFormatter_NoExternalResources(t *testing.T) {
    formatter := NewHTMLFormatter(FormatterConfig{})
    data, _ := formatter.Format(sampleResult)
    
    html := string(data)
    
    // Should not have external script/css links
    assert.NotRegexp(t, `<script src=`, html)
    assert.NotRegexp(t, `<link.*href=`, html)
}
```

#### Files to Touch
- `internal/output/html_test.go` (new)

#### Dependencies
- T088: HTML formatter complete

#### Success Criteria
- [ ] Template tests pass
- [ ] No external resources verified
- [ ] Content validation works

---

## Performance Targets
- HTML generation: < 50ms
- File size: < 50KB typical
- Browser load time: < 1s

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Browser compatibility | Low | Low | Test on major browsers |
| Large traces | Low | Low | Pagination for >100 hops |

## Notes
- Consider adding dark/light theme toggle
- Could add map visualization later (would need external JS)
- SVG path diagram would be nice addition
